# yaml-language-server: $schema=https://schema.zeabur.app/template.json
apiVersion: zeabur.com/v1
kind: Template
metadata:
  name: v2ray
spec:
  description: A V2Ray + Nginx WebSocket proxy for Zeabur with automatic HTTPS and UUID configuration.
  icon: https://raw.githubusercontent.com/2dust/v2rayN/refs/heads/master/v2rayN/v2rayN/Resources/v2rayN.ico
  variables:
    - key: NGINX_DOMAIN
      type: DOMAIN
      name: Nginx Domain
      description: Your domain to be bound with Nginx (Zeabur will issue HTTPS automatically)
    - key: V2RAY_UUID
      type: STRING
      name: V2Ray User ID (UUID)
      description: Custom V2Ray user ID (UUID). You can generate one at https://www.uuidgenerator.net/
  readme: |
    # V2Ray Proxy (Zeabur Edition)
    ## Configuration Steps
    1. Generate a UUID from [uuidgenerator.net](https://www.uuidgenerator.net/).
    2. Enter it during deployment as V2Ray User ID.
    3. Zeabur will automatically start V2Ray and Nginx with HTTPS.

    ## Client Setup
    - Protocol: vmess  
    - Address: your domain  
    - Port: 443  
    - UUID: (the one you entered)  
    - Transport: ws  
    - Path: /ws  
    - TLS: on

    ## Notes
    - This service is for personal or educational use only.
    - Zeabur automatically handles HTTPS.

  services:
    - name: v2ray
      icon: https://raw.githubusercontent.com/2dust/v2rayN/refs/heads/master/v2rayN/v2rayN/Resources/v2rayN.ico
      template: PREBUILT_V2
      spec:
        source:
          image: teddysun/v2ray:latest
        ports:
          - id: v2port
            port: 1080
            type: HTTP
        configs:
          - path: /etc/v2ray/config.json
            template: |-
              {
                "inbounds": [
                  {
                    "port": 1080,
                    "protocol": "vmess",
                    "settings": {
                      "clients": [
                        {
                          "id": "${V2RAY_UUID}",
                          "alterId": 0
                        }
                      ]
                    },
                    "streamSettings": {
                      "network": "ws",
                      "wsSettings": {
                        "path": "/ws"
                      }
                    }
                  }
                ],
                "outbounds": [
                  {
                    "protocol": "freedom"
                  }
                ]
              }
            envsubst: true

    - name: nginx
      icon: https://www.svgrepo.com/show/373924/nginx.svg
      template: PREBUILT_V2
      spec:
        source:
          image: library/nginx:1.27
        ports:
          - id: web
            port: 443
            type: HTTPS
        volumes:
          - id: html
            dir: /usr/share/nginx/html
        configs:
          - path: /etc/nginx/nginx.conf
            template: |-
              worker_processes  5;
              error_log  stderr;
              worker_rlimit_nofile 8192;
              events {}

              http {
                  default_type application/octet-stream;
                  log_format   main '$remote_addr - $remote_user [$time_local]  $status '
                      '"$request" $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
                  access_log   /dev/stdout  main;
                  sendfile     on;
                  tcp_nopush   on;
                  server_names_hash_bucket_size 128;

                  server {
                      listen 443 ssl;
                      server_name _;
                      ssl_certificate /etc/nginx/certs/fullchain.pem;
                      ssl_certificate_key /etc/nginx/certs/privkey.pem;

                      location / {
                          root /usr/share/nginx/html;
                          index index.html index.htm;
                      }

                      location /ws {
                          proxy_redirect off;
                          proxy_pass http://v2ray.zeabur.internal:1080;
                          proxy_http_version 1.1;
                          proxy_set_header Upgrade $http_upgrade;
                          proxy_set_header Connection "upgrade";
                          proxy_set_header Host $http_host;
                          proxy_set_header X-Real-IP $remote_addr;
                          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      }
                  }
              }
      domainKey: NGINX_DOMAIN
